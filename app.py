# app.py (ìµœì¢… í†µí•© ë²„ì „)
import streamlit as st
from agent import Agent

# --- 1. í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(
    page_title="ë™ì„œìš¸ëŒ€í•™êµ ë²•ë¥  ì±—ë´‡",
    page_icon="âš–ï¸",
    layout="wide"
)

# --- 2. Agent ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìºì‹œì— ì €ì¥í•˜ì—¬ í•œ ë²ˆë§Œ ìƒì„± ---
@st.cache_resource
def get_agent():
    """
    Streamlitì˜ ìºì‹œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ Agent ê°ì²´ë¥¼ ì•± ì „ì²´ì—ì„œ í•œ ë²ˆë§Œ ìƒì„±í•©ë‹ˆë‹¤.
    ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ë¥¼ ì´ë™í•˜ê±°ë‚˜ ìœ„ì ¯ê³¼ ìƒí˜¸ì‘ìš©í•  ë•Œë§ˆë‹¤
    ë¬´ê±°ìš´ Agent ëª¨ë¸ì„ ë‹¤ì‹œ ë¡œë“œí•˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """
    with st.spinner("ë²•ë¥  AI ì—ì´ì „íŠ¸ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."):
        agent_instance = Agent()
    return agent_instance

# --- 3. ì‚¬ì´ë“œë°” ë©”ë‰´ ë° í˜ì´ì§€ ë¼ìš°íŒ… ---
st.sidebar.title("ğŸ“‚ ë©”ë‰´")
page = st.sidebar.radio(
    "í˜ì´ì§€ ì„ íƒ",
    ["í™ˆ", "ë²•ë¥  ì±—ë´‡ ë°ëª¨", "ë¬¸ì˜í•˜ê¸°"]
)

# ===================================================================
# "í™ˆ" í˜ì´ì§€
# ===================================================================
if page == "í™ˆ":
    st.title("âš–ï¸ ë™ì„œìš¸ëŒ€í•™êµ ë²•ë¥  ì±—ë´‡ ì‚¬ì´íŠ¸")
    st.subheader("ê°œìš”")

    col_left, col_right = st.columns([2, 1])

    with col_left:
        st.markdown(
            """
            ë³¸ ì‚¬ì´íŠ¸ëŠ” ë™ì„œìš¸ëŒ€í•™êµ ì»´í“¨í„°ì†Œí”„íŠ¸ì›¨ì–´ê³¼ ì¡¸ì—… ê³¼ì œë¡œ ì œì‘ëœ ë²•ë¥  ì±—ë´‡ì…ë‹ˆë‹¤.  
            íŠ¹íˆ ê°œë°œìë“¤ì´ ìì£¼ ë§ˆì£¼ì¹˜ëŠ” ì§€ì‹ ì¬ì‚°ê¶Œ(ì €ì‘ê¶Œ, ìƒí‘œ, ì˜¤í”ˆ ì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤ ë“±)ê³¼
            ê´€ë ¨ëœ ë²•ì  ë¶€ë‹´ ì—¬ë¶€ë¥¼ ê°„ë‹¨íˆ ì§„ë‹¨í•˜ê³  ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.
            """,
            unsafe_allow_html=True,
        )
        st.markdown(
            """
            ### ğŸ”¹ ì£¼ìš” ê¸°ëŠ¥
            - **ë²•ë¥  ì •ë³´ ì œê³µ:** ì €ì‘ê¶Œ, ìƒí‘œê¶Œ ë“± ë³µì¡í•œ ë²•ë¥  ê°œë…ì„ ì‰½ê²Œ í’€ì–´ ì„¤ëª…í•©ë‹ˆë‹¤.
            - **ì‚¬ë¡€ ê¸°ë°˜ ì§„ë‹¨:** ì‚¬ìš©ìì˜ ìƒí™©ì„ ì…ë ¥í•˜ë©´, ê´€ë ¨ëœ ë²•ì  ìŸì ê³¼ ì£¼ì˜ì‚¬í•­ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
            - **ë™ì  ì •ë³´ íƒìƒ‰:** í•„ìš”ì‹œ, AI ì—ì´ì „íŠ¸ê°€ ì›¹ì—ì„œ ìµœì‹  ì •ë³´ë¥¼ ì°¾ì•„ ë‹µë³€ì— í™œìš©í•©ë‹ˆë‹¤.
            """
        )
    with col_right:
        # ì—¬ê¸°ì— ë¡œê³  ì´ë¯¸ì§€ë‚˜ ê´€ë ¨ ì´ë¯¸ì§€ë¥¼ ë„£ìœ¼ë©´ ì¢‹ìŠµë‹ˆë‹¤.
        st.image("https://www.du.ac.kr/p/img/sub/logo.png", width=200 )
        st.info("ì‚¬ì´ë“œë°”ì˜ 'ë²•ë¥  ì±—ë´‡ ë°ëª¨' í˜ì´ì§€ì—ì„œ AI ì±—ë´‡ì„ ì‚¬ìš©í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

# ===================================================================
# "ë²•ë¥  ì±—ë´‡ ë°ëª¨" í˜ì´ì§€
# ===================================================================
elif page == "ë²•ë¥  ì±—ë´‡ ë°ëª¨":
    st.title("ğŸ¤– ë™ì„œìš¸ëŒ€í•™êµ ë²•ë¥  ì±—ë´‡ ")
    st.caption("AI ì—ì´ì „íŠ¸ì—ê²Œ ì§€ì‹ì¬ì‚°ê¶Œ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”.")

    # --- Agent ë° ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™” ---
    agent = get_agent()
    if "messages" not in st.session_state:
        st.session_state.messages = [
            {
                "role": "assistant",
                "content": (
                    "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì§€ì‹ì¬ì‚°ê¶Œ ë²•ë¥  ìƒë‹´ì„ ìœ„í•´ ì„¤ê³„ëœ AI ì—ì´ì „íŠ¸ 'ê¹¡ê¹¡ë´‡'ì…ë‹ˆë‹¤.\n"
                    "ì €ì‘ê¶Œ, ìƒí‘œ, ì˜¤í”ˆ ì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤ ë“± ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”."
                ),
            },
        ]

    # --- ì´ì „ ëŒ€í™” ë‚´ìš© í‘œì‹œ ---
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
            # ë””ë²„ê·¸ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œ
            if "debug" in message and message["debug"]:
                # st.info(f"**[DEBUG]** {message['debug']}") # ì´ ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬
                pass # ifë¬¸ ë¸”ë¡ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ pass ì¶”ê°€


    # --- ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ ---
    if prompt := st.chat_input("ì €ì‘ê¶Œ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."):
        # 1. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ê¸°ë¡í•˜ê³  í™”ë©´ì— í‘œì‹œ
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # 2. AI ì—ì´ì „íŠ¸ ë‹µë³€ ìƒì„± ë° í‘œì‹œ
        with st.chat_message("assistant"):
            with st.spinner("AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                try:
                    # âœ… ìš°ë¦¬ Agentì˜ ë°˜í™˜ í˜•ì‹ (answer, meta)ì— ë§ê²Œ ìˆ˜ì •
                    answer, meta = agent.answer(prompt)
                    
                    # ë””ë²„ê·¸ ì •ë³´ ìƒì„± (ë¡œê·¸ì—ëŠ” ë‚¨ê¸°ì§€ë§Œ í™”ë©´ì—ëŠ” í‘œì‹œ ì•ˆ í•¨)
                    debug_info = (
                        f"ì´ˆê¸° íŒë‹¨: `{meta.get('initial_action', 'N/A')}` â†’ "
                        f"ìµœì¢… ì•¡ì…˜: `{meta.get('final_action', 'N/A')}` | "
                        f"AI í‰ê°€ ì ìˆ˜: `{meta.get('reward', 0.0):.2f}`"
                    )
                    
                    # ë‹µë³€ë§Œ í™”ë©´ì— í‘œì‹œ
                    st.markdown(answer)
                    # st.info(f"**[DEBUG]** {debug_info}") # ì´ ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬

                    # 3. AI ë‹µë³€ê³¼ ë””ë²„ê·¸ ì •ë³´ë¥¼ ì„¸ì…˜ ê¸°ë¡ì— ì¶”ê°€
                    # (ì„¸ì…˜ ê¸°ë¡ì—ëŠ” debug ì •ë³´ë¥¼ ë‚¨ê²¨ë‘¬ì•¼, í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ì „ ëŒ€í™”ì— debug ì°½ì´ ì•ˆ ëœ¨ëŠ” ë¡œì§ì´ ìœ ì§€ë©ë‹ˆë‹¤)
                    st.session_state.messages.append({
                        "role": "assistant",
                        "content": answer,
                        "debug": debug_info
                    })

                except Exception as e:
                    error_message = f"ì£„ì†¡í•©ë‹ˆë‹¤, ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"
                    st.error(error_message)
                    st.session_state.messages.append({
                        "role": "assistant",
                        "content": error_message,
                        "debug": None
                    })

# ===================================================================
# "ë¬¸ì˜í•˜ê¸°" í˜ì´ì§€
# ===================================================================
elif page == "ë¬¸ì˜í•˜ê¸°":
    st.subheader("ğŸ“¨ ë¬¸ì˜ ë° í”¼ë“œë°±")
    st.write("ì±—ë´‡ì˜ ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•œ ì†Œì¤‘í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.")

    with st.form("contact_form", clear_on_submit=True):
        name = st.text_input("ì´ë¦„ (ì„ íƒ)")
        email = st.text_input("ì´ë©”ì¼ (ì„ íƒ)")
        category = st.selectbox(
            "ë¬¸ì˜ ìœ í˜•",
            ["ë‹µë³€ í’ˆì§ˆ í”¼ë“œë°±", "ë²„ê·¸ ì œë³´", "ê¸°ëŠ¥ ì œì•ˆ", "ê¸°íƒ€"]
        )
        message = st.text_area("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", height=150, placeholder="ì˜ˆ: 'OOO'ì— ëŒ€í•œ ë‹µë³€ì´ ë¶€ì •í™•í–ˆì–´ìš”.")

        submitted = st.form_submit_button("ì œì¶œí•˜ê¸°")

        if submitted:
            if not message:
                st.error("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            else:
                # ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì—¬ê¸°ì„œ DB ì €ì¥ or ì´ë©”ì¼ ì „ì†¡ ì²˜ë¦¬
                st.success("ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤! ì±—ë´‡ ê°œì„ ì— í° ë„ì›€ì´ ë©ë‹ˆë‹¤.")
